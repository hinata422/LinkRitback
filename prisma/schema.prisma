// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // アプリ用（Pooler経由）
  directUrl = env("DIRECT_URL")   // マイグレーション用（直接接続）
}

model User {
  uid          String  @id @default(uuid()) @db.Uuid
  linkUserCode String  @unique @map("link_user_code") @db.VarChar(255)
  name         String  @db.VarChar(36) // display_name から name に変更
  mbtiType     String? @map("mbti_type") @db.VarChar(10) // 任意(NULL)

  // リレーション（つながり）
  eventPosts   EventPost[]

  @@map("users")
}

// イベント原本
model Event {
  id     String @id @default(uuid()) @db.Uuid
  title  String @db.VarChar(256)
  place  String @db.VarChar(256)
  detail String @db.Text
  // category は削除されました

  // リレーション
  posts        EventPost[]
  editedEvents EventEdited[]

  @@map("events")
}

// 投稿管理
model EventPost {
  id        String   @id @default(uuid()) @db.Uuid
  uid       String   @db.Uuid
  eventId   String   @map("event_id") @db.Uuid
  postTime  DateTime @default(now()) @map("post_time")
  postLimit DateTime @map("post_limit")

  // リンク設定
  user      User     @relation(fields: [uid], references: [uid], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_posts")
}

// MBTI別加工データ
model EventEdited {
  id           String @id @default(uuid()) @db.Uuid
  eventsId     String @map("events_id") @db.Uuid
  mbtiType     String @map("mbti_type") @db.VarChar(36)
  detailEdited String @map("detail_edited") @db.Text

  // リンク設定
  event        Event  @relation(fields: [eventsId], references: [id], onDelete: Cascade)

  // ユニーク制約 (同じイベント×同じMBTIは1つだけ)
  @@unique([eventsId, mbtiType])
  @@map("events_edited")
}